#include <stdio.h>
#include "gh3x_demo_algo_call.h"
#include "gh3x_demo_algo_call_inner.h"
#include "gh3x_demo_algo_config.h"
#include "goodix_sys_bia.h"
#include "GoMoreLibStruct.h"
#include "GoMoreLib.h"
#include "impedance_algo.h"
#include "BiaSampleManager.h"

#define __USE_GORMORE_BIA_ALGORITHM__   (0)

#if (__USE_GOODIX_BIA_ALGORITHM__)

#define BIA_MODE_DEMO       0  //手表demo工作模式
#define BIA_MODE_Z_BODY     1  //EVK阻抗测量：自测Zbody
#define BIA_MODE_Z_CONTACT  2  //EVK阻抗测量接触阻抗和Zbody都测

#define BIA_FrameNum_Cali    0   //// 采集校准电阻
#define BIA_FrameNum_RxBody  1   //// 采集人体阻抗
#define BIA_FrameNum_LeadStart    2  ////LeadDet开始的FrameNum
#define BIA_FrameNum_LeadEnd    5    ////LeadDet结束的FrameNum
#define BIA_DropInvlidData_Num          6    // slot或者frame 切换后需要丢掉几帧无效数据 

#define BIA_IQ_DATA_MASK 0x1000
#define BIA_RESULT_NUM 16
extern GU8 guchBiaFrameNum; 
extern GS32 giIDataOffset;
extern GU16 g_usBiaMeasureMode;
extern STImpedanceAglo stImpedanceAglo;

GU8  guchDropDateFlag = 0;
GU8  guchDropDateCnt = 0;
GU8  guchLast_SlotNum = 0;
GU8	 guchLast_FrameNum = 0;

#if __USE_GORMORE_BIA_ALGORITHM__
GS64 bsp_rtc_get_timestamp(void);

int rtc_current_time = 1682058349;
workoutAuthParameters auth;
GU8 sdkMemBia[1024*8];
char prevData[1024*4];
IndexIO mInput;
struct StartHealthInput startIn;
float i_arr[300];// = {0,30,-23,-146,-271,-395,-519,-644,-771,-900,-1028,-1156,-1279,-1403,-1528,-1651,-1773,-1926,-1996,-1993,-1992,-1993,-1993,-1994,-1987,-1981,-1979,-1978,-1981,-1979,-1980,-1982,-1984,-1988,-1993,-1999,-1999,-2000,-2004,-2006,-2009,-2008,-2008,-2005,-2002,-2003,-2003,-2002,-1994,-1983,-1971,-1961,-1952,-1941,-1930,-1919,-1912,-1903,-1890,-1879,-1871,-1862,-1853,-1848,-1855,-1866,-1877,-1887,-1895,-1904,-1913,-1923,-1932,-1942,-1951,-1953,-1958,-1961,-1961,-1958,-1949,-1937,-1925,-1912,-1903,-1893,-1882,-1872,-1863,-1856,-1849,-1850,-1847,-1845,-1845,-1844,-1848,-1850,-1848,-1854,-1856,-1857,-1856,-1857,-1859,-1862,-1871,-1874,-1876,-1878,-1877,-1879,-1874,-1873,-1875,-1878,-1886,-1894,-1907,-1914,64,66,71,75,77,79,77,76,76,75,74,81,90,96,110,119,123,125,130,130,127,127,127,128,129,130,133,135,135,137,134,129,128,127,124,127,128,128,129,131,128,126,123,121,119,119,121,126,128,127,124,121,121,118,114,110,108,107,107,107,111,110,111,111,109,114,117,113,103,97,90,82,77,75,74,70,66,65,62,59,63,62,64,72,81,92,103,110,113,115,114,115,115,114,116,117,113,111,108,105,106,108,109,110,112,110,108,110,108,104,98,97,95,91,89,88,89,85,82,85,1980,2589,5802,9716,13629,17540,21455,25368,29279,33191,37102,41243,46379,51782,57184,62587,67987,72777,74973,76469,77964,79461,80957,82458,83960,85459,86958,88228,88503,88516,88526,88533,88545,88558,88556,88557,88562,88568,88569,88566,88567,88570,88573,88572,88575,88572,88571,88572,88569,88567,88570,88570,88567,88563,88564,88566,88564,88563,88565,88563,88559,88563,88567,88566,88567,88568,88569,88569,88567,88564,88563,88563,88562,88560,88556,88559,88560,88558,88557,88560,88561,88564,88567,88564,88571,88578,88578,88576,88576,88578,88581,88580,88579,88575,88574,88576,88577,88578,88579,88583,88583,88581,88579,88579,88575,88567,88558,88553,88556,88558,88556,88554,88551,88549,88544,88542,88538,88534,88535,88537,1980,2434,4729,7489,10252,13015,15778,18545,21311,24078,26841,29739,33211,36835,40455,44076,47701,50875,52205,53069,53932,54796,55660,56521,57380,58232,59081,59796,59938,59935,59936,59938,59935,59928,59928,59926,59928,59924,59922,59915,59916,59921,59932,59945,59956,59958,59956,59947,59939,59932,59922,59912,59902,59903,59905,59911,59910,59914,59912,59911,59908,59904,59901,59904,59912,59916,59925,59935,59942,59942,59939,59937,59936,59934,59936,59937,59935,59933,59927,59925,59921,59916,59914,59916,59916,59916,59920,59924,59925,59927,59928,59930,59938,59950,59967,59974,59979,59988,59991,59992,59988,59978,59968,59958,59948,59943,59944,59943,59942,59941,59942,59948,59952,59953,59955,59955,59962,59973,59980,59987,60000,60001,60003,60002,60000,60000,59997,59996,59998,59999,59997,59994,59989,59985,59985,59981,59972,59970,59965,59961,59959,59959,59959,59953,59947,59946,59948,59950,59955,59960,59961,59967,59970,59975,59979,59979,59982,59979,59979,59980,59978,59976,59978,59972,59963,59958,59960,59962,59963,59963,59961,59958,59950,59939,59921,59907,59898,59888,59876,59869,59862,59857,59855,59851,59850,59845,59842,59845,59850,59860,59877,59892,59904,59910,59918,59928,59937,59944,59943,59944,59941,59944,59947,59950,59956,59960,59961,59962,59968,59972,59964,59956,59950,59942,59935,59926,59917,59904,59889,59875,59860,59851,59848,59851,59850,59853,59862,59874,59886,59895,59901,59907,59917,59929,59944,59958,59970,59977,59977,59973,59972,59973,59973,59971,59968,59971,59972,59975,59980,59986,59987,59989,59992,59996,59998,60001,60003,60000,60001,60001,60000,59995,59990,59983,59971,59958,59943,59934,59924,59914,59908,59902,59892,59885,59881,59877,59872,59870,59867,59867,59864,59866,59872,59871,59871,59874,59874,59876,59879,59879,59879,59880,59888,59898,59911,59925,59939,59952,59966,59975,59984,59992,60001,60008,60018,60029,60038,60046,60048,60045,60043,60032,60019,60006,59991,59979,59967,59955,59944,59930,59917,59906,59894,59884,59872,59856,59845,59845,59856,59866,59875,59885,59893,59898,59907,59918,59928,59937,59944,59951,59960,59978,59993,59999,60000,60002,60008,60014,60020,60025,60027,60028,60030,60030,60031,60029,60023,60014,59997,59983,59972,59962,59948,59931,59916,59901,59888,59878,59874,59873,59870,59872,59875,59881,59892,59904,59911,59917,59928,59940,59954,59963,59962,59959,59953,59946,59939,59931,59925,59917,59908,59904,59896,59891,59878,59866,59858,59856,59860,59858,59855,59856,59856,59853,59849,59849,59852,59853,59853,59850,59852,59854,59851,59851,59853,59864,59873,59877,59885,59897,59906,59914,59920,59924,59933,59940,59947,59954,59962,59970,59977,59977,59976,59977,59974,59971,59973,59977,59977,59978,59977,59980,59985,59986,59987,59984,59983,59985,59988,59990,59993,59998,60003,60003,60006,60007,60011,60012,60011,60013,60017,60019,60016,60014,60011,60008,60010,60007,59997,59996,59998,59998,59994,59996,59995,59993,59993,59993,59996,60001,60006,60008,60006,60006,60012,60014,60016,60017,60017,60013,60014,60016,60014,60016,60021,60026,60030,60036,60043,60050,60058,60058,60056,60056,60059,60056,60050,60048,60047,60040,60031,60018,60006,59991,59976,59963,59947,59942,59943,59943,59946,59957,59966,59971,59975,59980,59983,59990,60000,60014,60022,60029,60037,60043,60043,60042,60040,60038,60037,60036,60036,60037,60040,60044,60044,60043,60043,60045,60046,60044,60043,60046,60047,60047,60045,60041,60040,60039,60035,60032,60029,60030,60033,60031,60027,60026,60026,60024,60025,60026,60027,60030,60026,60028,60034,60037,60040,60043,60040,60043,60047,60044,60038,60028,60015,60003,59993,59982,59980,59982,59982,59978,59976,59976,59979,59977,59974,59976,59980,};
float q_arr[300];// = {0,94,245,331,418,500,582,668,752,834,915,1001,1087,1172,1257,1341,1427,1418,1352,1351,1349,1350,1354,1357,1357,1359,1363,1364,1363,1362,1361,1363,1363,1364,1363,1366,1364,1361,1358,1353,1347,1343,1337,1333,1329,1326,1330,1327,1323,1321,1320,1316,1313,1311,1305,1304,1305,1311,1313,1311,1306,1301,1290,1283,1280,1272,1268,1266,1265,1267,1273,1272,1272,1267,1268,1269,1273,1276,1279,1283,1284,1288,1289,1290,1292,1290,1286,1286,1289,1292,1292,1294,1295,1295,1297,1302,1303,1304,1303,1300,1299,1298,1297,1293,1290,1286,1283,1281,1277,1278,1278,1276,1277,1279,1282,1286,1287,1289,1293,1298,-32,-31,-28,-25,-18,-19,-18,-18,-20,-21,-24,-29,-27,-27,-28,-29,-33,-33,-31,-32,-30,-25,-26,-26,-25,-23,-22,-22,-27,-25,-24,-25,-23,-22,-21,-22,-26,-28,-25,-23,-26,-32,-30,-26,-23,-27,-31,-31,-34,-34,-37,-39,-42,-41,-48,-50,-46,-46,-49,-48,-45,-45,-44,-48,-47,-47,-46,-43,-45,-50,-44,-39,-43,-42,-43,-40,-38,-37,-30,-22,-19,-19,-21,-20,-16,-15,-18,-17,-11,-5,1,6,6,11,6,3,2,2,5,9,12,16,19,12,6,5,1,-8,-14,-19,-19,-19,-19,-21,-23,-26,-25,-25,-26,-27,-1336,-1593,-2902,-4480,-6058,-7636,-9215,-10794,-12374,-13954,-15534,-17317,-19976,-22870,-25764,-28658,-31548,-34182,-35761,-37074,-38388,-39701,-41009,-42318,-43628,-44935,-46245,-47349,-47577,-47574,-47569,-47565,-47560,-47555,-47551,-47545,-47540,-47538,-47539,-47538,-47535,-47534,-47536,-47542,-47545,-47541,-47544,-47545,-47549,-47552,-47558,-47564,-47566,-47565,-47566,-47566,-47569,-47568,-47567,-47563,-47563,-47564,-47563,-47561,-47560,-47562,-47561,-47560,-47560,-47561,-47565,-47569,-47569,-47571,-47570,-47572,-47571,-47571,-47575,-47578,-47576,-47575,-47578,-47580,-47584,-47587,-47584,-47580,-47581,-47585,-47590,-47588,-47590,-47595,-47591,-47589,-47594,-47597,-47597,-47598,-47596,-47597,-47599,-47603,-47606,-47603,-47601,-47604,-47605,-47608,-47612,-47612,-47611,-47611,-47609,-47610,-47609,-47609,-47606,-47601,-1336,-1505,-2188,-2954,-3720,-4482,-5249,-6014,-6781,-7547,-8314,-9360,-11613,-14193,-16771,-19350,-21929,-24336,-26230,-28041,-29850,-31664,-33476,-35291,-37104,-38916,-40726,-42257,-42577,-42573,-42573,-42572,-42572,-42574,-42575,-42575,-42582,-42586,-42585,-42582,-42577,-42578,-42580,-42581,-42583,-42579,-42581,-42584,-42581,-42577,-42579,-42583,-42583,-42582,-42588,-42589,-42592,-42593,-42594,-42595,-42597,-42602,-42599,-42593,-42594,-42599,-42598,-42592,-42587,-42584,-42582,-42584,-42588,-42590,-42590,-42594,-42595,-42600,-42603,-42605,-42608,-42608,-42609,-42615,-42622,-42623,-42624,-42625,-42627,-42624,-42623,-42619,-42626,-42627,-42627,-42626,-42623,-42623,-42626,-42624,-42619,-42618,-42614,-42611,-42604,-42607,-42609,-42612,-42607,-42603,-42605,-42614,-42617,-42621,-42621,-42618,-42621,-42625,-42630,-42634,-42639,-42635,-42631,-42631,-42637,-42641,-42642,-42644,-42645,-42641,-42643,-42648,-42651,-42654,-42652,-42651,-42647,-42647,-42650,-42651,-42645,-42642,-42641,-42636,-42635,-42641,-42642,-42639,-42637,-42632,-42630,-42633,-42634,-42638,-42642,-42643,-42649,-42656,-42659,-42660,-42660,-42658,-42656,-42660,-42661,-42664,-42670,-42671,-42670,-42669,-42667,-42666,-42660,-42653,-42647,-42647,-42645,-42643,-42641,-42637,-42635,-42634,-42633,-42631,-42634,-42637,-42641,-42640,-42644,-42646,-42643,-42643,-42645,-42647,-42649,-42646,-42641,-42637,-42635,-42633,-42631,-42625,-42620,-42617,-42613,-42612,-42617,-42618,-42619,-42620,-42623,-42628,-42633,-42636,-42634,-42635,-42634,-42627,-42622,-42618,-42616,-42614,-42609,-42605,-42600,-42590,-42586,-42583,-42580,-42580,-42580,-42579,-42578,-42586,-42590,-42597,-42602,-42601,-42603,-42606,-42611,-42616,-42617,-42617,-42618,-42618,-42619,-42620,-42621,-42621,-42623,-42625,-42628,-42638,-42649,-42653,-42652,-42655,-42661,-42670,-42673,-42674,-42675,-42673,-42675,-42677,-42678,-42676,-42670,-42662,-42654,-42653,-42653,-42651,-42647,-42640,-42637,-42640,-42642,-42649,-42651,-42652,-42653,-42652,-42656,-42659,-42662,-42662,-42662,-42662,-42660,-42660,-42662,-42661,-42666,-42664,-42661,-42665,-42672,-42682,-42687,-42689,-42688,-42687,-42688,-42690,-42687,-42683,-42678,-42677,-42672,-42668,-42665,-42655,-42642,-42634,-42628,-42622,-42620,-42616,-42615,-42615,-42617,-42618,-42619,-42617,-42617,-42620,-42623,-42627,-42634,-42637,-42636,-42639,-42638,-42640,-42638,-42635,-42637,-42640,-42642,-42642,-42642,-42636,-42637,-42637,-42632,-42627,-42627,-42624,-42624,-42624,-42624,-42628,-42630,-42630,-42631,-42632,-42631,-42635,-42633,-42631,-42631,-42630,-42627,-42626,-42626,-42623,-42620,-42614,-42612,-42611,-42612,-42613,-42615,-42615,-42617,-42621,-42620,-42621,-42623,-42625,-42629,-42636,-42640,-42646,-42647,-42641,-42639,-42637,-42639,-42645,-42651,-42651,-42654,-42660,-42664,-42665,-42666,-42668,-42673,-42676,-42681,-42688,-42689,-42693,-42693,-42687,-42679,-42679,-42677,-42672,-42672,-42672,-42667,-42662,-42658,-42649,-42642,-42636,-42633,-42632,-42629,-42626,-42626,-42622,-42620,-42622,-42616,-42609,-42611,-42612,-42610,-42611,-42614,-42619,-42621,-42618,-42617,-42621,-42624,-42627,-42630,-42632,-42636,-42643,-42647,-42649,-42654,-42659,-42662,-42663,-42665,-42671,-42678,-42679,-42684,-42691,-42696,-42700,-42701,-42702,-42705,-42706,-42706,-42703,-42705,-42707,-42706,-42702,-42697,-42696,-42696,-42694,-42695,-42692,-42692,-42694,-42688,-42685,-42686,-42690,-42689,-42690,-42695,-42699,-42705,-42707,-42707,-42709,-42707,-42710,-42710,-42711,-42716,-42718,-42716,-42713,-42712,-42710,-42711,-42712,-42710,-42710,-42709,-42704,-42703,-42700,-42699,-42695,-42691,-42689,-42687,-42689,-42687,-42684,-42680,-42676,-42672,-42667,-42666,-42663,-42661,-42658,-42655,-42655,-42653,-42655,-42657,-42657,-42658,-42659,-42660,-42660,-42661,-42665,-42667,-42671,-42674,-42675,-42677,-42681,-42682,-42682,-42683,-42682,-42686,-42688,-42689,-42692,-42692,-42690,-42691,-42695,-42698,-42703,-42705,-42704,-42703,-42701,-42696,-42690,-42685,-42684,-42678,-42674,-42672,-42670,-42667,-42662,-42656,-42650,-42648,-42652,-42654,-42654,-42655,-42658,-42658,-42656,-42659,-42665,-42670,-42671,-42671,-42668,-42667,-42670,-42672,-42671,-42673,-42677,-42677,-42678,-42679,-42680,-42679,-42675,-42670,};
int8_t f_arr[300];// = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,};
uint8_t l_arr[100];// = {21,67,72,66,45,62,63,59,66,61,64,71,56,65,60,60,};
//static int inputlen = 0;
static int inputcnt = 0;

void InitBiaBuff()
{
    memset(sdkMemBia, 0, 1024*8);
    memset(prevData, 0, 1024*4);
}

GS16 GomoreBiaInit(void)
{
    auth.rtcCurrentTime = bsp_rtc_get_timestamp();
    auth.deviceId = "E8EECC2E9701";
    auth.devIdLen = strlen(auth.deviceId);
    auth.pKey = "3uyx48RRuBOSk+HXvB3At4YVDiNYctxMstFfY4xdWXtm1Ip7CybjFFUSiRhblWwa";
    GS16 ret = setAuthParameters(&auth);
    InitBiaBuff();
    memset(prevData, 0, getPreviousDataSize());

    //setWorkoutAuthParametersExample(rtc_current_time, &auth);
    //setAuthParameters(&auth);
    
    GF32 userinfo[7];
    userinfo[0] = gnBiaPInfo[3]; //Age (Unit: year)mAge1;
    userinfo[1] = gnBiaPInfo[2];     //0: Female; 1: Male.mGender1;
    userinfo[2] = gnBiaPInfo[0];//mHeightCm1;
    userinfo[3] = gnBiaPInfo[1]/10.0f;//mWeightKg1;
    userinfo[4] = -1.0f;//mHrMax1;
    userinfo[5] = -1.0f;//mHrRest1;
    userinfo[6] = -1.0f;//mStaminaLevel1;
    ret = healthIndexInitUser(sdkMemBia, rtc_current_time, userinfo, prevData);
    
    //setIndexIODefaultValue(&mInput);
    mInput.timestamp = bsp_rtc_get_timestamp();
    mInput.biaLength = 0;
    mInput.biaI = i_arr;
    mInput.biaQ = q_arr;
    mInput.biaFlag = f_arr;
//	  inputlen = 0;
    inputcnt = 0;
    
// Start static balance
    memset(&startIn, 0, sizeof(struct StartHealthInput));
    startIn.actionType = 10000;
    startIn.action.bodyComposition.weight = gnBiaPInfo[1]/10.0f;;//51.2;
    startIn.action.bodyComposition.height = gnBiaPInfo[0];//155;
    startHealth(&startIn);
    
    
    return ret;
}

GS8 GomoreBiaAlgoExe(const STFrameInfo * const pstFrameInfo)
{
    if(0 == pstFrameInfo )
    {
        return GH3X_RET_GENERIC_ERROR;
    }
    GS8 chAlgoRet = 0;
    GU8 uchChMapNum = 0;
    GU16 usChMap[2] = {0};
    //GU32 chAlgoRet = 0;

    //uchBiaFlagValueBit = pstFrameInfo->pstFlagInfo->uchFlagBits;
    uchChMapNum = pstFrameInfo->pstGh3xData->uchChnlNum;
    for(GU8 uchChMapIndex = 0; uchChMapIndex < uchChMapNum; uchChMapIndex++)
    {
        usChMap[uchChMapIndex] = pstFrameInfo->pstGh3xData->pusChnlMap[uchChMapIndex];
        if(usChMap[uchChMapIndex] & BIA_IQ_DATA_MASK)
        {
            q_arr[inputcnt] = pstFrameInfo->pstGh3xData->punRawdata[uchChMapIndex];
        }
        else
        {
            i_arr[inputcnt] = pstFrameInfo->pstGh3xData->punRawdata[uchChMapIndex];
        }
    }
    
    f_arr[inputcnt] = pstFrameInfo->pstFlagInfo->punFlag[1];
    inputcnt++;
//		inputlen++;
    if(pstFrameInfo->pstFlagInfo->punFlag[0] == 1)
    {
        mInput.timestamp = bsp_rtc_get_timestamp();
        mInput.biaLength = inputcnt;
        mInput.biaI = i_arr;
        mInput.biaQ = q_arr;
        mInput.biaFlag = f_arr;
        updateIndex(&mInput);
        //inputlen = 0;
        inputcnt = 0;

    }
    if(*pstFrameInfo->punFrameCnt > (pstFrameInfo->pstGh3xData->usSampleRate * 30 + 30)) 
    {
        struct EndHealthInput endIn;
        struct EndHealthOutput endOut;
        memset(&endIn, 0, sizeof(struct EndHealthInput));
        endIn.action.bodyComposition.success = 1;
        endHealth(&endIn, &endOut);
        // EXPECT_NEAR(endOut.action.bodyComposition.bmr, 1147.f, 1147 * ERROR_TOLERANCE);
        // EXPECT_NEAR(endOut.action.bodyComposition.water, 26.3f, 26.3f * ERROR_TOLERANCE);
        // EXPECT_NEAR(endOut.action.bodyComposition.protein, 7.1f, 7.1f * ERROR_TOLERANCE);
        // EXPECT_NEAR(endOut.action.bodyComposition.minerals, 2.64f, 2.64f * ERROR_TOLERANCE);
        // EXPECT_NEAR(endOut.action.bodyComposition.fat, 15.2f, 15.2f * ERROR_TOLERANCE);
        // EXPECT_NEAR(endOut.action.bodyComposition.smm, 19.3f, 19.3f * ERROR_TOLERANCE);
        // EXPECT_NEAR(endOut.action.bodyComposition.ffm, 36.0f, 36.0f * ERROR_TOLERANCE);

//				printf("%f %f %f %f %f %f %f\n",
//						endOut.action.bodyComposition.bmr, endOut.action.bodyComposition.water,
//						endOut.action.bodyComposition.protein, endOut.action.bodyComposition.minerals,
//						endOut.action.bodyComposition.fat, endOut.action.bodyComposition.smm,
//						endOut.action.bodyComposition.ffm
		//		);
        pstFrameInfo->pstAlgoData->pnResults[0] = 1;//结束采样
        pstFrameInfo->pstAlgoData->pnResults[1] = endOut.action.bodyComposition.bmr * 100; 
        pstFrameInfo->pstAlgoData->pnResults[2] = endOut.action.bodyComposition.fat * 100;// 
        pstFrameInfo->pstAlgoData->pnResults[3] = endOut.action.bodyComposition.protein * 100;// 
        pstFrameInfo->pstAlgoData->pnResults[4] = endOut.action.bodyComposition.minerals * 100;// 
        pstFrameInfo->pstAlgoData->pnResults[5] = endOut.action.bodyComposition.ffm * 100;// 
        pstFrameInfo->pstAlgoData->pnResults[6] = endOut.action.bodyComposition.smm * 100;// 
        pstFrameInfo->pstAlgoData->pnResults[7] = endOut.action.bodyComposition.water * 100;// 

        pstFrameInfo->pstAlgoData->unResultBits = 0x00FF; //  
        pstFrameInfo->pstAlgoData->uchResultNum = GH3X_BitCount(pstFrameInfo->pstAlgoData->unResultBits);
        pstFrameInfo->pstAlgoData->uchFlag = 1;
 
    }
    return chAlgoRet;
}
GS8 GomoreBiaAlgoDeinit(const STFrameInfo * const pstFrameInfo)
{
    stopHealthSession(sdkMemBia);
    InitBiaBuff();

    //free(sdkMemBia);
    //free(prevData);
}

#endif

GU8 GH3XBiaCheckParam(void)
{
	//GU8 uchRet;
	//gnBiaPInfo[0] = 0;
	if(gnBiaPInfo[0] < 99 || gnBiaPInfo[0] > 256 || 
		gnBiaPInfo[1] < 350 || gnBiaPInfo[1] > 2560 || 
		gnBiaPInfo[3] < 10 || gnBiaPInfo[3] > 127 
	)
	{
		return 1;
	}
	else
		return 0;
}

GU32 goodix_bia_init_func(GU32 fs)
{
    GU32 uiRet = 0;
    //GU8 *uchBiaVersion;
    GS32 uiPInfo[GOODIX_BIA_PARAMS_NUM_MAX] = {0};
    //uchBiaVersion = BIAAlgoVersion();

    //GH3X_ALGO_LOG_PARAM("bia algorithm version : %s\r\n", uchBiaVersion);
    //GH3X_ALGO_LOG_PARAM("bia algorithm legal chnl num : %d\r\n", gstBiaAlgoChnlMap.uchNum);

    for(GU8 i=0; i<GOODIX_BIA_PARAMS_NUM_MAX; i++)
    {
        uiPInfo[i] = gnBiaPInfo[i];
    }
		
    GH3X_ALGO_LOG_PARAM("[%s]:params = %d,%d,%d,%d,%d,%d\r\n", __FUNCTION__,
                                                                            fs,
                                                                            uiPInfo[0],
                                                                            uiPInfo[1],
                                                                            uiPInfo[2],
                                                                            uiPInfo[3],
                                                                            uiPInfo[4]);

    uiRet = BIAAlgoInit(uiPInfo, fs, g_usBiaMeasureMode);
    guchDropDateFlag = 0;
    guchDropDateCnt = 0;
    guchLast_SlotNum = 0;
    guchLast_FrameNum = 0;
    
#if    __USE_GORMORE_BIA_ALGORITHM__
    uiRet = GomoreBiaInit();
#endif
    return uiRet;
}

GU32 goodix_bia_deinit_func(void)
{
    GU32 uiBiaDeinitRet;
    uiBiaDeinitRet = BIAAlgoDeInit();
    return uiBiaDeinitRet;
}


GS8 GH3XBiaAlgoInit(const STFrameInfo * const pstFrameInfo)
{
    memset(&pstFrameInfo->pstAlgoData->uchFlag, 0, sizeof(GU8) + sizeof(GU8) + sizeof(GU32));
    GU32 chBiaRet = GX_BIA_ALGO_FAILED;
    GS8 chRet = GH3X_RET_GENERIC_ERROR;
    chBiaRet = goodix_bia_init_func(pstFrameInfo ->pstGh3xData->usSampleRate);
    if (chBiaRet == GX_BIA_ALGO_OK)
    {
        chRet = GH3X_RET_OK;
        GH3X_ALGO_LOG_PARAM("[%s]GH3X_BiaInit success!!\r\n", __FUNCTION__);
    }
    else
    {
        chRet = GH3X_RET_GENERIC_ERROR;
        GH3X_ALGO_LOG_PARAM("Bia init error , bia error code: [%d]!\r\n", chBiaRet);
    }
    return chRet;
}



GS8 GH3XBiaAlgoDeinit(const STFrameInfo * const pstFrameInfo)
{
    GU32 chBiaRet = GX_BIA_ALGO_FAILED;
    GS8 chRet = GH3X_RET_GENERIC_ERROR;
    chBiaRet = goodix_bia_deinit_func();
    if (chBiaRet == GX_BIA_ALGO_OK)
    {
        chRet = GH3X_RET_OK;
        GH3X_ALGO_LOG_PARAM("[%s]GH3X_BiaDeInit success!!\r\n", __FUNCTION__);
    }
    else
    {
        chRet = GH3X_RET_GENERIC_ERROR;
        GH3X_ALGO_LOG_PARAM("Bia init error , bia error code: [%d]!\r\n", chBiaRet);
    }
#if    __USE_GORMORE_BIA_ALGORITHM__
    chRet = GomoreBiaAlgoDeinit(pstFrameInfo);
#endif
    return chRet;
}


//call algo 2-level interface
GS8 GH3XBiaAlgoExe(const STFrameInfo * const pstFrameInfo)
{
    if(0 == pstFrameInfo )
    {
        return GH3X_RET_GENERIC_ERROR;
    }
    STUpdataFlag stUpdataFlag;
    pstFrameInfo->pstAlgoData->uchFlag = 0;
    GU8 uchChMapNum = 0;
    GU16 usChMap[2] = {0};
    GU32 chAlgoRet = 0;
    GU8 uchFrameId = pstFrameInfo->pstFlagInfo->punFlag[4]; 
    GU8 uchSlotId = pstFrameInfo->pstFlagInfo->punFlag[3];
    complex_S32 stIq;

    uchChMapNum = pstFrameInfo->pstGh3xData->uchChnlNum;
    for(GU8 uchChMapIndex = 0; uchChMapIndex < uchChMapNum; uchChMapIndex++)
    {
        usChMap[uchChMapIndex] = pstFrameInfo->pstGh3xData->pusChnlMap[uchChMapIndex];
        if(usChMap[uchChMapIndex] & BIA_IQ_DATA_MASK)
        {
            stIq.imag = pstFrameInfo->pstGh3xData->punRawdata[uchChMapIndex];
        }
        else
        {
            stIq.real = pstFrameInfo->pstGh3xData->punRawdata[uchChMapIndex];
        }
    }

    EM_BIA_SAMPLE_STATE emState = BiaImpedanceAlgoExe(&stImpedanceAglo, &stIq, uchFrameId, uchSlotId, pstFrameInfo,&stUpdataFlag);
    GH3X_ALGO_LOG_PARAM("[%s]: SlotId=%d,State=%d\r\n", __FUNCTION__,uchSlotId,emState);
    BiaSampleManagerSampleSwitch(emState);
    BiaImpedanceAlgoResult2Protocol(&stUpdataFlag,&stImpedanceAglo, pstFrameInfo);
   
    return chAlgoRet;
}

#endif


